services:
  # One-off execution: Run the bot once and exit
  # Usage: docker compose run --rm mastodon-bot
  mastodon-bot:
    build: .
    image: mastodon-bot:latest
    container_name: mastodon-bot
    volumes:
      # Mount your config file (required)
      - ./config.yaml:/app/config.yaml:ro
      # Mount your secrets file (required)
      - ./secrets.yaml:/app/secrets.yaml:ro
      # Mount your media directory (required)
      - ./media:/app/media:ro
      # Persist visited database (will be created automatically on first run)
      # Mount as a bind mount to persist in current directory
      - ./visited.pickledb:/app/visited.pickledb
      # Persist visited texts database (will be created automatically on first run)
      - ./visited_texts.pickledb:/app/visited_texts.pickledb
      # Uncomment if you have an info database file:
      # - ./info.pickledb:/app/info.pickledb:ro
      # Uncomment if you want to use a post texts file:
      # - ./post_texts.txt:/app/post_texts.txt:ro
    environment:
      # Optional: Override config values with environment variables if needed
      - TZ=UTC
      # Optional: Set to "true" to allow posting images that have already been posted
      # This bypasses the visited.pickledb tracking. Default: "false"
      # - ALLOW_REPOST_VISITED=false
    restart: "no"
    profiles:
      - manual

  # Scheduled execution: Run the bot on a recurring schedule
  # Usage: docker compose up -d mastodon-bot-scheduled
  mastodon-bot-scheduled:
    build: .
    image: mastodon-bot:latest
    container_name: mastodon-bot-scheduled
    entrypoint: ["/app/scheduler.sh"]
    volumes:
      # Mount your config file (required)
      - ./config.yaml:/app/config.yaml:ro
      # Mount your secrets file (required)
      - ./secrets.yaml:/app/secrets.yaml:ro
      # Mount your media directory (required)
      - ./media:/app/media:ro
      # Persist visited database (will be created automatically on first run)
      # Mount as a bind mount to persist in current directory
      - ./visited.pickledb:/app/visited.pickledb
      # Persist visited texts database (will be created automatically on first run)
      - ./visited_texts.pickledb:/app/visited_texts.pickledb
      # Uncomment if you have an info database file:
      # - ./info.pickledb:/app/info.pickledb:ro
      # Uncomment if you want to use a post texts file:
      # - ./post_texts.txt:/app/post_texts.txt:ro
    environment:
      # Optional: Override config values with environment variables if needed
      - TZ=UTC
      # Schedule interval: Xs (seconds), Xm (minutes), Xh (hours), Xd (days)
      # Default: 4h (4 hours)
      - SCHEDULE_INTERVAL=4h
      # Optional: Set to "true" to allow posting images that have already been posted
      # This bypasses the visited.pickledb tracking. Default: "false"
      # - ALLOW_REPOST_VISITED=false
    restart: unless-stopped
